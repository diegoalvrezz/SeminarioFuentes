---
title: "seminario fuentes"
author: "Pablo, Diego y Dario"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


Importamos las bases de datos
```{r}
library(readr)
library(ggplot2)
library(tidyverse)
library(dplyr)
library(stringr)
aire <- read_delim("./C6H6_BaP__2021_Irreg.csv")


fumadores<-read_delim("./Datos_fumadores/Fumadores.csv", delim = ";")
fumadores

defunciones_mes <- read_delim("./DATA/defuncion_mes.csv", delim =";")
defunciones_mes

defuncion_poblacion <- read_delim("./DATA/defuncion_poblacion.csv", delim =";")
defuncion_poblacion
#arboles_superficie <- read_delim("./Datos_arboles/provincia_superficie_altura.csv", delim = ";")

arboles_uso <- read_delim("./Datos_arboles/Arbolesusofinal.csv", delim = ";",escape_double = FALSE, trim_ws = TRUE)
arboles_uso

#arboles_extension <- read_delim("./Datos_arboles/provincia_extensionterritorio.csv", delim = ";")

habitantes <- read_delim("./DATA/48254.csv", delim = ";")

```




```{r}
fumadores <- fumadores%>%
  mutate(
    CCAA= case_when( ## cambiamos el nombre con un case_When
      fumadores$`Comunidades y Ciudades Autónomas`== "Andalucía" ~ "Andalucia",
      fumadores$`Comunidades y Ciudades Autónomas`== "Aragón" ~ "Aragon",
      fumadores$`Comunidades y Ciudades Autónomas`== "Asturias (Principado de)" ~ "Asturias",
      fumadores$`Comunidades y Ciudades Autónomas`== "Balears (Illes)" ~ "Baleares",
      fumadores$`Comunidades y Ciudades Autónomas`== "Canarias" ~ "Canarias",
      fumadores$`Comunidades y Ciudades Autónomas`== "Cantabria" ~ "Cantabria",
      fumadores$`Comunidades y Ciudades Autónomas`== "Castilla y León" ~ "CyL",
      fumadores$`Comunidades y Ciudades Autónomas`== "Castilla - La Mancha" ~ "Castilla la Mancha",
      fumadores$`Comunidades y Ciudades Autónomas`== "Cataluña" ~ "Cataluña",
      fumadores$`Comunidades y Ciudades Autónomas`== "Comunitat Valenciana" ~ "C.Valencia",
      fumadores$`Comunidades y Ciudades Autónomas`== "Extremadura" ~ "Extremadura",
      fumadores$`Comunidades y Ciudades Autónomas`== "Galicia" ~ "Galicia",
      fumadores$`Comunidades y Ciudades Autónomas`== "Madrid (Comunidad de)" ~ "Madrid",
      fumadores$`Comunidades y Ciudades Autónomas`== "Murcia (Región de)" ~ "Murcia",
      fumadores$`Comunidades y Ciudades Autónomas`== "Navarra (Comunidad Foral de)" ~ "Navarra",
      fumadores$`Comunidades y Ciudades Autónomas`== "País Vasco" ~ "País Vasco",
      fumadores$`Comunidades y Ciudades Autónomas`== "Rioja (La)" ~ "La Rioja",
      fumadores$`Comunidades y Ciudades Autónomas`== "Ceuta (Ciudad Autónoma de)" ~ "Ceuta",
      fumadores$`Comunidades y Ciudades Autónomas`== "Melilla (Ciudad Autónoma de)" ~ "Melilla",
    )) %>%
select(`CCAA`,`Consumo de tabaco`,Total,) %>%
  na.exclude()%>%
  filter(`Consumo de tabaco` != "TOTAL")
fumadores
      
```

```{r}
aire<- aire%>%
  mutate(
    CCAA=case_when(
      PROVINCIA=="18" ~ "Granada",
      PROVINCIA=="33" ~ "Asturias",
      PROVINCIA=="46" ~ "Valencia",
      PROVINCIA=="25" ~ "Cataluña",
      PROVINCIA=="45" ~ "Toledo",
      PROVINCIA=="50" ~ "Zaragoza",
      PROVINCIA=="41" ~ "Sevilla",
      PROVINCIA=="23" ~ "Jaén",
      PROVINCIA=="13" ~ "Ciudad Real",
      PROVINCIA=="16" ~ "Cuenca",
      PROVINCIA=="4" ~ "Almería",
      PROVINCIA=="14" ~ "Córdoba",
      PROVINCIA=="29" ~ "Málaga",
      PROVINCIA=="19"~ "Guadalajara",
      PROVINCIA=="2" ~ "Albacete",
      PROVINCIA=="47" ~ "Valladolid",
      PROVINCIA=="24" ~ "León",
      PROVINCIA=="9" ~ "Burgos",
      PROVINCIA=="22" ~ "Huesca",
      PROVINCIA=="12" ~ "Castellón",
    )
  )%>%
select(VALOR,CCAA)%>%
  distinct(CCAA, .keep_all = TRUE)

aire_agrupado <- aire %>%
  group_by(CCAA) %>%
  summarise(media = mean(VALOR, na.rm = TRUE))%>%
   mutate(
    CCAA = case_when(
      CCAA %in% c("Granada", "Almería", "Sevilla", "Jaén", "Córdoba", "Málaga") ~ "Andalucia",
      CCAA %in% c("León", "Burgos", "Valladolid") ~ "Castilla y León",
      CCAA %in% c("Huesca", "Zaragoza") ~ "Aragón",
      CCAA %in% c("Cuenca", "Toledo", "Ciudad Real", "Guadalajara", "Albacete") ~ "Castilla la Mancha",
      CCAA  %in% c("Castellón", "Valencia") ~ "C.Valencia",
     
      TRUE ~ CCAA 
      )
  )
# Calcula la media por grupo
aire_media_comunidad <- aire_agrupado %>%
  group_by(CCAA) %>%
  summarise(media = mean(media, na.rm = TRUE))
aire_media_comunidad


```



```{r}
# Usa la función mutate() y case_when() para cambiar los valores de la columna
arboles_uso <- arboles_uso %>%
  mutate(
    Comunidad = toupper(str_trim(Comunidad)), #Usamos la funcion toupper para converir Comunidad en mayusculas ya que si no no se lee la fuente de datos
    CCAA_arboles_uso = case_when(
      Comunidad == "ANDALUCÍA" ~ "Andalucia",
      Comunidad == "ARAGÓN" ~ "Aragon",
      Comunidad == "CANARIAS" ~ "Canarias",
      Comunidad == "CANTABRIA" ~ "Cantabria",
      Comunidad == "CASTILLA LA MANCHA" ~ "Castilla la Mancha",
      Comunidad == "CASTILLA Y LEÓN" ~ "CyL",
      Comunidad == "CATALUÑA" ~ "Cataluña",
      Comunidad == "COMUNIDAD DE MADRID" ~ "Madrid",
      Comunidad == "COMUNIDAD FORAL DE NAVARRA" ~ "Navarra",
      Comunidad == "COMUNIDAD VALENCIANA" ~ "C.Valencia",
      Comunidad == "EXTREMADURA" ~ "Extremadura",
      Comunidad == "GALICIA" ~ "Galicia",
      Comunidad == "ILLES BALEARS" ~ "Baleares",
      Comunidad == "LA RIOJA" ~ "La Rioja",
      Comunidad == "PAÍS VASCO" ~ "País Vasco",
      Comunidad == "PRINCIPADO DE ASTURIAS" ~ "Asturias",
      Comunidad == "REGIÓN DE MURCIA" ~ "Murcia"
    )
  ) %>%
  select('CCAA_arboles_uso',`Usos`,`0 - 199`,`200 - 399`,`400 - 599`,`600 - 799`,`800 - 999`,`1.000 - 1.199`,`1.200 - 1.399`,`1.400 - 1.599`,`1.600 - 1.799`,`1.800 - 1.999`,`>= 2.000`) %>%
  na.exclude()

arboles_uso

```


```{r}
tumores<-defuncion_poblacion %>%
  rename("Total" = ...2,"<10000" = ...3,"10000-20000" = ...4, "20000-50000" = ...5,"50000-100000" = ...6, "<100000" = ...7, "Capital" = ...8 ) %>%
  slice(55:58) %>%
  select('Defunciones según causa de muerte. Avance enero-mayo 2020':Capital)

tumores
```


```{r}

habitantes_refinado <- habitantes %>%
  filter(Periodo == "1/1/2020") %>%
  select('Comunidades y Ciudades Autónomas', Total, Periodo) %>%
  na.exclude()
habitantes_refinado$Total <- as.numeric(habitantes_refinado$Total)


habitantes_refinado <- habitantes_refinado %>%
  mutate(
    CCAA = case_when(
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Andalucía" ~ "Andalucia",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Aragón" ~ "Aragon",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Canarias" ~ "Canarias",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Cantabria" ~ "Cantabria",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Castilla - La Mancha" ~ "Castilla la Mancha",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Castilla y León" ~ "CyL",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Cataluña" ~ "Cataluña",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Madrid, Comunidad de" ~ "Madrid",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Navarra, Comunidad Foral de" ~ "Navarra",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Comunitat Valenciana" ~ "C.Valencia",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Extremadura" ~ "Extremadura",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Galicia" ~ "Galicia",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Balears, Illes" ~ "Baleares",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Rioja, La" ~ "La Rioja",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "País Vasco" ~ "País Vasco",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Asturias, Principado de" ~ "Asturias",
      habitantes_refinado$`Comunidades y Ciudades Autónomas` == "Murcia, Región de" ~ "Murcia"
    ))%>%
select('CCAA',Total,Periodo)%>%
  na.exclude()%>%
  group_by(CCAA)%>%
  summarise(Total = mean(Total, na.rm = TRUE))
habitantes_refinado




```

```{r}
fumadores_habitantes <- full_join(x = fumadores, 
                              y = habitantes_refinado,
                              by = "CCAA")
fumadores_habitantes$Personas <- as.numeric(gsub(",", ".", fumadores_habitantes$Total.x)) * fumadores_habitantes$Total.y / 100
fumadores_habitantes<-fumadores_habitantes%>%
  na.omit(fumadores_habitantes)%>%
  select(CCAA,`Consumo de tabaco`,Personas)
fumadores_habitantes

```

```{r}
fumadores_aire <- full_join(x= fumadores_habitantes,
                            y = aire_media_comunidad,
                            by = "CCAA"
                            )
fumadores_aire <- na.omit(fumadores_aire)
fumadores_aire_diario <- fumadores_aire%>%
  filter(`Consumo de tabaco` == "Fumador diario")



ggplot(data = fumadores_aire_diarios,
       aes(x = media, y = Personas)) +
  geom_point(aes(factor = CCAA))
  xlab("Calidad del Aire") +
  ylab("Número de Fumadores Diarios") +
  ggtitle("Relación Calidad del Aire y el Número de Fumadores Diarios ")



```

